<script>
(() => {
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbybDOB9aIZ8vYJPx_efJDHLGsOVYKMMUPKZ6yGcLg9loyaFJv9EkyPV6GfN7oPw6qFW/exec";
  const $ = id => document.getElementById(id);
  const els = {
    vin: $('vin'), decodeBtn: $('decodeBtn'),
    year: $('year'), make: $('make'), model: $('model'),
    appraiser: $('appraiser'), customerName: $('customerName'),
    jdRetail: $('jdRetail'), cleanTrade: $('cleanTrade'), roughTrade: $('roughTrade'),
    recon: $('recon'), npaOffer: $('npaOffer'), mileage: $('mileage'),
    notes: $('notes'), acvBox: $('acvBox'), saveBtn: $('saveBtn')
  };

  // Real-time calculation on value changes
  const valueFields = [els.jdRetail, els.cleanTrade, els.roughTrade, els.recon, els.npaOffer, els.mileage];
  valueFields.forEach(el => el.addEventListener('input', calculate));

  // Save button enable on required fields
  const required = [els.appraiser, els.year, els.make, els.model];
  required.forEach(el => el.addEventListener('input', checkSave));

  // Run checkSave also when store radio buttons change
  document.querySelectorAll('input[name="store"]').forEach(radio => {
    radio.addEventListener('change', checkSave);
  });

  // VIN button (disabled)
  els.decodeBtn.onclick = () => {
    alert("VIN decoder is currently disabled.\nAwaiting API credentials from DataOne Software.");
  };

  function calculate() {
    const clean = Number(els.cleanTrade.value) || 0;
    const rough = Number(els.roughTrade.value) || 0;
    const npa = Number(els.npaOffer.value) || 0;
    const recon = Number(els.recon.value) || 0;
    const miles = Number(els.mileage.value) || 0;
    const jd = Number(els.jdRetail.value) || 0;

    let base = (clean + rough + npa) / 3;
    if (npa >= clean && clean > 0) {
      base = (rough * 1.4 + npa * 1.4 + clean * 0.2) / 3;
    }

    const mileagePenalty = miles > 10000 ? (miles - 10000) * 0.06 : 0;
    const beforeDiscount = base - recon - mileagePenalty;

    const discount = jd >= 21000 ? 0.95 : jd >= 10000 ? 0.90 : 0.85;
    const acv = beforeDiscount * discount;

    const formatted = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(acv);

    if (jd === 0 && clean === 0 && rough === 0 && npa === 0) {
      els.acvBox.innerHTML = "Enter values → ACV appears here";
    } else {
      els.acvBox.innerHTML = `FINAL ACV<br><strong>${formatted}</strong>`;
    }
  }

  function checkSave() {
    const storeOk = document.querySelector('input[name="store"]:checked');
    const ready = els.appraiser.value.trim() && 
                  storeOk && 
                  els.year.value.trim() && 
                  els.make.value.trim() && 
                  els.model.value.trim();
    
    els.saveBtn.disabled = !ready;
    
    // Optional: visual feedback
    if (ready) {
      els.saveBtn.style.opacity = '1';
      els.saveBtn.style.cursor = 'pointer';
    } else {
      els.saveBtn.style.opacity = '0.6';
      els.saveBtn.style.cursor = 'not-allowed';
    }
  }

  // Dooley only on leaving the mileage field
  els.mileage.addEventListener('blur', () => {
    const clean = Number(els.cleanTrade.value) || 0;
    const rough = Number(els.roughTrade.value) || 0;
    const npa = Number(els.npaOffer.value) || 0;
    const recon = Number(els.recon.value) || 0;
    const miles = Number(els.mileage.value) || 0;
    const jd = Number(els.jdRetail.value) || 0;

    let base = (clean + rough + npa) / 3;
    if (npa >= clean && clean > 0) {
      base = (rough * 1.4 + npa * 1.4 + clean * 0.2) / 3;
    }

    const mileagePenalty = miles > 10000 ? (miles - 10000) * 0.06 : 0;
    const beforeDiscount = base - recon - mileagePenalty;

    const discount = jd >= 21000 ? 0.95 : jd >= 10000 ? 0.90 : 0.85;
    const acv = beforeDiscount * discount;

    const storeOk = document.querySelector('input[name="store"]:checked');
    const readyForSave = els.appraiser.value.trim() && storeOk && 
                        els.year.value.trim() && els.make.value.trim() && 
                        els.model.value.trim();

    const valuesFilled = jd > 0 && clean > 0 && rough > 0 && npa > 0 && recon >= 0 && miles > 0;

    if (readyForSave && valuesFilled && acv < (jd * 0.7)) {
      document.getElementById("dooleyOverlay").style.display = "flex";
    }
  });

  // Close Dooley
  document.getElementById("dooleyClose").onclick = () => {
    document.getElementById("dooleyOverlay").style.display = "none";
  };
  document.getElementById("dooleyOverlay").onclick = (e) => {
    if (e.target === document.getElementById("dooleyOverlay")) {
      document.getElementById("dooleyOverlay").style.display = "none";
    }
  };

  // SAVE logic
  els.saveBtn.onclick = () => {
    els.saveBtn.disabled = true;
    els.saveBtn.textContent = "Saving...";
    const store = document.querySelector('input[name="store"]:checked')?.value || '';
    const acvText = els.acvBox.querySelector('strong')?.textContent || '0';
    const payload = {
      action: "save",
      timestamp: new Date().toISOString(),
      customerName: els.customerName.value.trim(),
      appraiser: els.appraiser.value.trim(),
      store,
      vin: els.vin.value.trim(),
      year: els.year.value,
      make: els.make.value,
      model: els.model.value,
      jdRetail: Number(els.jdRetail.value)||0,
      cleanTrade: Number(els.cleanTrade.value)||0,
      roughTrade: Number(els.roughTrade.value)||0,
      serviceEstimate: Number(els.recon.value)||0,
      npaOffer: Number(els.npaOffer.value)||0,
      mileage: Number(els.mileage.value)||0,
      acv: acvText.replace(/[^0-9.-]/g,''),
      notes: els.notes.value
    };
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = SCRIPT_URL;
    form.target = 'hiddenIframe';
    form.style.display = 'none';
    const input = document.createElement('input');
    input.name = 'payload';
    input.value = JSON.stringify(payload);
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
    form.remove();
    alert("Saved & logged successfully!");
    document.querySelectorAll('input:not([type="radio"])').forEach(i => i.value = '');
    document.querySelectorAll('textarea').forEach(t => t.value = '');
    document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
    els.acvBox.innerHTML = "Enter values → ACV appears here";
    els.saveBtn.disabled = false;
    els.saveBtn.textContent = "Save & Log Appraisal";
  };

  const iframe = document.createElement('iframe');
  iframe.name = 'hiddenIframe';
  iframe.style.display = 'none';
  document.body.appendChild(iframe);

  // Initial run
  calculate();
  checkSave();
})();
</script>
